<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Inventario</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .input-grande {
            min-width: 350px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Gestión de Inventario</h1>
        <form class="row g-3 justify-content-center" onsubmit="return false;">
            <div class="col-auto">
                <label for="buscar" class="col-form-label">Buscar producto:</label>
            </div>
            <div class="col-auto">
                <input type="text" id="buscar" class="form-control form-control-lg input-grande"
                    placeholder="Ingrese nombre de producto">
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary btn-lg" id="btnBuscar">Buscar</button>
            </div>
        </form>
        <div id="resultado" class="mt-4"></div>
    </div>
    <script>
        document.getElementById('btnBuscar').addEventListener('click', function () {
            const nombre = document.getElementById('buscar').value.trim();
            if (!nombre) {
                document.getElementById('resultado').innerHTML = '<div class="alert alert-warning">Por favor ingrese el nombre de un producto.</div>';
                return;
            }
            fetch(`/api/buscar_producto?nombre=${encodeURIComponent(nombre)}`)
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    if (data.error) {
                        html = `<div class="alert alert-danger">${data.error}</div>`;
                    } else {
                        data.forEach(producto => {
                            html += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">${producto.nombre}</h5>
                                    <p class="card-text">
                                        <strong>Código:</strong> ${producto.codigo}<br>
                                    </p>
                                    <h6>Sucursales:</h6>
                                    <ul>
                        `;
                            producto.sucursales.forEach((suc, idx) => {
                                html += `
        <li>
            <strong>Sucursal:</strong> ${suc.sucursal} |
            <strong>Cantidad:</strong> <span id="cantidad-${producto.codigo}-${idx}">${suc.cantidad}</span> |
            <strong>Precio:</strong> $${suc.precio}
            <button class="btn btn-success btn-sm ms-2" onclick="venderProducto('${producto.codigo}', '${suc.sucursal}', 'cantidad-${producto.codigo}-${idx}')">Venta</button>
        </li>
    `;
                            });
                            html += `
                                    </ul>
                                </div>
                            </div>
                        `;
                        });
                    }
                    document.getElementById('resultado').innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('resultado').innerHTML = `<div class="alert alert-danger">Error al consultar el producto.</div>`;
                });
        });

        function venderProducto(codigo, sucursal, cantidadSpanId) {
            fetch('/api/vender', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ codigo: codigo, sucursal: sucursal })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        // Actualiza la cantidad en pantalla
                        document.getElementById(cantidadSpanId).textContent = data.cantidad_restante;
                    }
                })
                .catch(error => {
                    alert('Error al realizar la venta');
                });
        }
    </script>
</body>

</html>